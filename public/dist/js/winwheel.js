const x=window.moment,g=window.io(),_=`ws://${location.hostname}${location.port===""?"":`:${location.port}`}/streaming`,y=new WebSocket(_);let T=!1,A=[];function I(t,n){return Math.floor(Math.random()*(n-t+1))+t}function M(){let t=I(0,360);for(;t%10==0||A.includes(t);)t=I(0,360);return t+20}const h=document.getElementById("winwheelCanvas"),e=h.getContext("2d"),C=80,f=50,i=h.width/2,c=h.height/2;let s=M(),S=s;const z=.2,R=.99,N=1e-4,D=6e4,u=[{id:"p1",label:"$100"},{id:"p2",label:"$250"},{id:"p3",label:"$500"},{id:"p4",label:"$1.000"},{id:"p5",label:"$2.000"},{id:"p6",label:"$5.000"},{id:"p7",label:"$10.000"},{id:"p8",label:"$25.000"},{id:"p9",label:"$50.000"},{id:"p10",label:"$100.000"},{id:"p11",label:"$250.000"},{id:"p12",label:"$500.000"},{id:"p13",label:"$1.000.000"}];let b=[{id:"j1",label:"$100.000",bgPriceColor:"#e344d1",borderColor:"#fff",textColor:"#e344d1",bgTextColor:"#fff",borderSize:2},{id:"j2",label:"$250.000",bgPriceColor:"#5588c5",borderColor:"#fff",textColor:"#5588c5",bgTextColor:"#fff",borderSize:2},{id:"j3",label:"$500.000",bgPriceColor:"#7340c9",borderColor:"#fff",textColor:"#7340c9",bgTextColor:"#fff",borderSize:2},{id:"j4",label:"$1.000.000",bgPriceColor:"#e75d6b",borderColor:"#fff",textColor:"#e75d6b",bgTextColor:"#fff",borderSize:2}];const O="#dddddd",$=new Image;$.src="/images/Roue_ADL.png";function m(){if(!e)return;e.clearRect(0,0,h.width,h.height);const t=2*Math.PI/b.length,n=250;b.forEach((l,o)=>{const a=t/u.length;u.forEach((r,d)=>{const w=s+t*o+a*d,E=w+a;e.beginPath(),e.moveTo(i,c),e.arc(i,c,n,w,E),e.lineTo(i,c),e.fillStyle=l.bgPriceColor,e.fill(),e.strokeStyle=l.borderColor,e.lineWidth=l.borderSize,e.stroke(),e.closePath();const p=w+a/1.3;e.save(),e.translate(i+Math.cos(p)*(n*.6),c+Math.sin(p)*(n*.6)),e.rotate(p),e.fillStyle=l.bgTextColor,e.font="bold 15px Arial",e.fillText(r.label,0,0),e.restore()})}),b.forEach((l,o)=>{e.beginPath(),e.moveTo(i,c),e.arc(i,c,C,t*o+s,t*(o+1)+s),e.fillStyle=O,e.fill(),e.strokeStyle=l.borderColor,e.lineWidth=l.borderSize,e.stroke(),e.closePath();const a=t*o+s+t/2;e.save(),e.translate(i+Math.cos(a)*(C*.7),c+Math.sin(a)*(C*.7)),e.rotate(a+Math.PI/2),e.fillStyle=l.textColor,e.font="bold 12px "+e.font.split(" ").slice(-1)[0],e.fillText(l.label,-e.measureText(l.label).width/2,0),e.restore()}),e.save(),e.beginPath(),e.arc(i,c,f,0,2*Math.PI),e.clip(),e.drawImage($,i-f,c-f,f*2,f*2),e.restore(),e.beginPath(),e.arc(i,c,f,0,2*Math.PI),e.strokeStyle="black",e.lineWidth=2,e.stroke(),e.save(),e.translate(i,c-n-20),e.beginPath(),e.moveTo(0,0),e.lineTo(-10,-20),e.lineTo(10,-20),e.closePath(),e.fillStyle="#e75d6b",e.fill(),e.strokeStyle="white",e.lineWidth=2,e.stroke(),e.restore()}function k(t,n){if(Date.now()-t<D&&n>N){s=(s+n)%(2*Math.PI);const o=n*R;m(),requestAnimationFrame(()=>k(t,o))}else{s=s%(2*Math.PI),m();const o=W();T&&g.emit("get draw result",JSON.stringify({winner:o.jackpot.label,prize:o.prize.label,angle:S}))}}function W(){const t=Math.PI*1.5,n=2*Math.PI/b.length,l=n/u.length;let o=(t-s)%(2*Math.PI);o<0&&(o+=2*Math.PI);const a=Math.floor(o/n),r=Math.floor(o%n/l);return{jackpot:b[a],prize:u[r]}}let P=!1;async function v(){if(P)return;P=!0,await L();const t=Date.now();k(t,z)}$.onload=m;const j=document.getElementById("countdown-number");function B(t){let n=setInterval(()=>{const l=x(),a=x(t).diff(l),r=x.duration(a),d={days:r.days()>9?r.days():`0${r.days()}`,hours:r.hours()>9?r.hours():`0${r.hours()}`,minutes:r.minutes()>9?r.minutes():`0${r.minutes()}`,seconds:r.seconds()>9?r.seconds():`0${r.seconds()}`};j.textContent=`${d.days} jours ${d.hours} heures ${d.minutes} minutes ${d.seconds} secondes`,a<=0&&(clearInterval(n),v())},1e3)}g.on("connect",()=>{T=!0,console.log("Connected to server"),g.emit("get next draw date"),g.on("send next draw date",t=>{t=JSON.parse(t),"angles"in t&&(A=t.angles,s=M(),S=s,m()),v(),"nextDrawinDate"in t&&B(t.nextDrawinDate)})});y.onmessage=t=>{console.log(t.data)};async function L(){try{const t=await navigator.mediaDevices.getDisplayMedia({video:!0,audio:!1}),n=new MediaRecorder(t),l=[];n.ondataavailable=o=>{l.push(o.data),console.log("ok",o.data),o.data.size>0&&y.send(o.data)},n.onstop=()=>{const o=new Blob(l,{type:"video/webm"})},n.start(1),setTimeout(()=>n.stop(),D)}catch(t){console.error("Erreur de capture : ",t)}}
